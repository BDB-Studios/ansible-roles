- name: Install nginx from apt
  apt:
    name: nginx
    state: latest
  become: true

- name: Create ssl directory
  file:
    path: "/etc/nginx/ssl"
    state: directory
  become: true

- name: Start nginx
  service:
    name: nginx
    state: started
  become: true

- block:
  - name: remove nginx default site
    file:
      path: "/etc/nginx/sites-enabled/default"
      state: absent
    become: true

  - name: create healthcheck default site
    copy:
      src: "./files/nginx.default.cfg"
      dest: "/etc/nginx/sites-available/999-healthcheck"
      owner: root
      group: root
      mode: 644
      backup: yes
    become: true

  - name: Enable healthcheck site
    file:
      src: "/etc/nginx/sites-available/999-healthcheck"
      dest: "/etc/nginx/sites-enabled/999-healthcheck"
      state: link
    become: true

  - name: create healtcheck dir if it doesn't exist
    file:
      path: /srv/healthcheck
      state: directory
      owner: app
      group: users
    become: true

  - name: Extract instance_id
    command: hostname
    register: instance_id

  - name: Copy the healthcheck file into the directory
    template:
      src: "./files/index.html"
      dest: "/srv/healthcheck/index.html"
      owner: app
      group: users
      mode: 644
    become: true

- name: Reload nginx
  service:
    name: nginx
    state: reloaded
  become: true